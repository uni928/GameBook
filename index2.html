<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ‰ΩìÈ®ì„Çµ„Ç§„Éà</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #story {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 15px;
      min-height: 200px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    .choice {
      margin: 10px 0;
    }
    button.choice-btn {
      display: block;
      margin-top: 5px;
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button.choice-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h2>„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ‰ΩìÈ®ì„Çµ„Ç§„Éà</h2>
  <div id="story">„Éö„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
  <div id="choices"></div>

  <script>
    let pageCount = 0;
    const maxPages = 20;
    let gameOver = false;
    let gameCleared = false;
    let isLoading = false;

    async function generatePage(text = "", choiceHistory = []) {
      const isFinal = (pageCount > maxPages);

      const prompt = isFinal ?
        `‰ª•‰∏ã„ÅØÊó•Êú¨Ë™û„ÅÆ„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ„ÅÆÊúÄÁµÇ„Éö„Éº„Ç∏„Åß„Åô„ÄÇË™≠ËÄÖ„ÅØÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„ÅßÁâ©Ë™û„ÇíÈÄ≤„ÇÅ„Å¶„Åç„Åæ„Åó„Åü„ÄÇ„Åì„Çå„ÅØ„Ç≤„Éº„É†„ÇØ„É™„Ç¢„ÅÆ„Éö„Éº„Ç∏„Åß„Åô„ÄÇ

„Åì„Çå„Åæ„Åß„ÅÆÈÅ∏ÊäûËÇ¢: ${choiceHistory.join(" ‚Üí ")}

Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„ÅÆÊú¨ÊñáÔºà400Â≠ó‰ª•ÂÜÖÔºâ„ÇíÊú¨Êñá: „Åã„ÇâÂßã„ÇÅ„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Êú¨Êñá: „Ç≤„Éº„É†„ÇØ„É™„Ç¢„ÄÇ„Åì„Çå„Åß„ÅÇ„Å™„Åü„ÅÆÂÜíÈô∫„ÅØÁµÇ„Çè„Çä„Åß„Åô„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ` :
        `‰ª•‰∏ã„ÅØÊó•Êú¨Ë™û„ÅÆ„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ„ÅÆ„Éö„Éº„Ç∏„Åß„Åô„ÄÇË™≠ËÄÖ„ÅØÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„ÅßÁâ©Ë™û„ÇíÈÄ≤„ÇÅ„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇÁèæÂú®„ÅØ${pageCount + 1}„Éö„Éº„Ç∏ÁõÆ„Åß„Åô„ÄÇ„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Å´„Å™„Çã„Åã20„Éö„Éº„Ç∏ÁõÆ„Åæ„ÅßÁ∂ö„Åë„Å¶‰∏ã„Åï„ÅÑ„ÄÇ„ÄÇ

„Åì„Çå„Åæ„Åß„ÅÆÈÅ∏ÊäûËÇ¢: ${choiceHistory.join(" ‚Üí ")}

Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„ÅÆÊú¨ÊñáÔºà400Â≠ó‰ª•ÂÜÖÔºâ„Å®3„Å§„ÅÆÈÅ∏ÊäûËÇ¢„Çí‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
Êú¨Êñá: ...
ÈÅ∏ÊäûËÇ¢:
1. ‚óã‚óã‚óã
2. ‚ñ≥‚ñ≥‚ñ≥
3. ‚ñ°‚ñ°‚ñ°
Ôºà„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Å´„Å™„ÇãÂ†¥Âêà„ÅØ"„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº"„Å®ÊòéË®òÔºâ`;

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: "You are an interactive Japanese gamebook writer." },
            { role: "user", content: prompt }
          ],
          temperature: 0.8,
          max_tokens: 512
        })
      });

      const data = await response.json();
      return data.choices?.[0]?.message?.content || "Áâ©Ë™û„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
    }

    let apiKey = prompt("OpenAI API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàsk-...Ôºâ:").trim();
    let choiceHistory = [];

    async function nextPage(choice = "") {
      if (gameOver || gameCleared || isLoading) return;
      isLoading = true;
      if (choice) choiceHistory.push(choice);

      const content = await generatePage("", choiceHistory);

      const storyEl = document.getElementById("story");
      const choicesEl = document.getElementById("choices");
      const parts = content.split("ÈÅ∏ÊäûËÇ¢:");

      if (content.includes("„Ç≤„Éº„É†„ÇØ„É™„Ç¢")) {
        storyEl.textContent = parts[0] + "\n\nüéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ üéâ";
        choicesEl.innerHTML = "";
        gameCleared = true;
        isLoading = false;
        return;
      }

      if (content.includes("„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº")) {
        storyEl.textContent = parts[0] + "\n\n--- „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº ---";
        choicesEl.innerHTML = "";
        gameOver = true;
        isLoading = false;
        return;
      }

      storyEl.textContent = parts[0].trim();
      const options = parts[1].trim().split(/\n+/);
      choicesEl.innerHTML = "";
      options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.textContent = `${opt}`;
        btn.className = "choice-btn";
        btn.onclick = () => {
          disableChoices();
          pageCount++;
          nextPage(opt);
        };
        choicesEl.appendChild(btn);
      });

      pageCount++;
      isLoading = false;
    }

    function disableChoices() {
      const buttons = document.querySelectorAll(".choice-btn");
      buttons.forEach(btn => btn.disabled = true);
    }

    nextPage();
  </script>
</body>
</html>
