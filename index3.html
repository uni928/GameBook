<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ‰ΩìÈ®ì„Çµ„Ç§„Éà</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #story {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 15px;
      min-height: 200px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    .choice {
      margin: 10px 0;
    }
    button.choice-btn {
      display: block;
      margin-top: 5px;
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button.choice-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h2>„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ‰ΩìÈ®ì„Çµ„Ç§„Éà</h2>
  <div id="story">„Éö„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
  <div id="choices"></div>

  <script>
    let pageCount = 0;
    const maxPages = 20;
    let gameOver = false;
    let geminiKey = "prompt("Gemini API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàsk-...Ôºâ:").trim();
    let choiceHistory = [];

    async function generatePage(choiceHistory = []) {
      const isFinalPage = pageCount > maxPages;
      const prompt = isFinalPage
        ? `‰ª•‰∏ã„ÅØÊó•Êú¨Ë™û„ÅÆ„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ„ÅÆÊúÄÁµÇ„Éö„Éº„Ç∏„Åß„Åô„ÄÇË™≠ËÄÖ„ÅØÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„ÅßÁâ©Ë™û„ÇíÈÄ≤„ÇÅ„Å¶„Åç„Åæ„Åó„Åü„ÄÇ„Åì„Çå„ÅØ„Ç≤„Éº„É†„ÇØ„É™„Ç¢„ÅÆ„Éö„Éº„Ç∏„Åß„Åô„ÄÇ

„Åì„Çå„Åæ„Åß„ÅÆÈÅ∏ÊäûËÇ¢: ${choiceHistory.join(" ‚Üí ")}

Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„ÅÆÊú¨ÊñáÔºà400Â≠ó‰ª•ÂÜÖÔºâ„ÇíÊú¨Êñá: „Åã„ÇâÂßã„ÇÅ„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Êú¨Êñá: „Ç≤„Éº„É†„ÇØ„É™„Ç¢„ÄÇ„Åì„Çå„Åß„ÅÇ„Å™„Åü„ÅÆÂÜíÈô∫„ÅØÁµÇ„Çè„Çä„Åß„Åô„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ` :
        `‰ª•‰∏ã„ÅØÊó•Êú¨Ë™û„ÅÆ„Ç≤„Éº„É†„Éñ„ÉÉ„ÇØ„ÅÆ„Éö„Éº„Ç∏„Åß„Åô„ÄÇË™≠ËÄÖ„ÅØÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„ÅßÁâ©Ë™û„ÇíÈÄ≤„ÇÅ„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇÁèæÂú®„ÅØ${pageCount + 1}„Éö„Éº„Ç∏ÁõÆ„Åß„Åô„ÄÇ„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Å´„Å™„Çã„Åæ„ÅßÁ∂ö„Åë„Å¶‰∏ã„Åï„ÅÑ„ÄÇ

„Åì„Çå„Åæ„Åß„ÅÆÈÅ∏ÊäûËÇ¢: ${choiceHistory.join(" ‚Üí ")}

Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„ÅÆÊú¨ÊñáÔºà400Â≠ó‰ª•ÂÜÖÔºâ„Å®3„Å§„ÅÆÈÅ∏ÊäûËÇ¢„Çí‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
Êú¨Êñá: ...
ÈÅ∏ÊäûËÇ¢:
1. ‚óã‚óã‚óã
2. ‚ñ≥‚ñ≥‚ñ≥
3. ‚ñ°‚ñ°‚ñ°
Ôºà„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Å´„Å™„ÇãÂ†¥Âêà„ÅØ"„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº"„Å®ÊòéË®òÔºâ`;

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.8,
              maxOutputTokens: 512
            }
          })
        }
      );

      if (!response.ok) throw new Error("Gemini API „Ç®„É©„Éº: " + response.status);
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "Áâ©Ë™û„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
    }

    async function nextPage(choice = "") {
      //if (gameOver || pageCount > maxPages + 1) return;
      if (choice) choiceHistory.push(choice);

      const storyEl = document.getElementById("story");
      const choicesEl = document.getElementById("choices");

      // disable all buttons temporarily
      const buttons = choicesEl.querySelectorAll("button");
      buttons.forEach(btn => btn.disabled = true);

      const content = await generatePage(choiceHistory);

      const parts = content.split("ÈÅ∏ÊäûËÇ¢:");

      if (content.includes("„Ç≤„Éº„É†„ÇØ„É™„Ç¢")) {
        storyEl.textContent = parts[0] + "\n\nüéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ üéâ";
        choicesEl.innerHTML = "";
        gameCleared = true;
        return;
      }

      if (content.includes("„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº")) {
        storyEl.textContent = parts[0] + "\n\n--- „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº ---";
        choicesEl.innerHTML = "";
        gameOver = true;
        return;
      }

      storyEl.textContent = parts[0].trim();
      const options = parts[1].trim().split(/\n+/);
      choicesEl.innerHTML = "";
      options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.textContent = `${opt}`;
        btn.className = "choice-btn";
        btn.disabled = false;
        btn.onclick = () => {
          pageCount++;
          nextPage(opt);
        };
        choicesEl.appendChild(btn);
      });

      pageCount++;
    }

    nextPage();
  </script>
</body>
</html>
