<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ—¥æœ¬èªæ–‡ç« ã®èª¤ã‚Šæ¤œå‡ºãƒ„ãƒ¼ãƒ«</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea {
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      width: 100%;
      height: 150px;
      box-sizing: border-box;
      margin-bottom: 10px;
      padding: 10px;
    }
    #output {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 150px;
    }
    .highlight {
      background-color: rgba(255, 0, 0, 0.3);
      font-weight: bold;
    }
    #status { margin-top: 10px; color: green; }
    #error { color: red; margin-top: 5px; }
    #spinner {
      display: none;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>æ—¥æœ¬èªæ–‡ç« ã®èª¤ã‚Šæ¤œå‡ºãƒ„ãƒ¼ãƒ«ï¼ˆChatGPT / Gemini å¯¾å¿œï¼‰</h2>
  <p><strong>æ“ä½œèª¬æ˜:</strong> <kbd>Ctrl + K</kbd> ã¾ãŸã¯ã€Œæ·»å‰Šã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§èª¤ã‚Šã‚’æ¤œå‡º</p>

  <label>ChatGPT APIã‚­ãƒ¼: <input id="apiKeyInput" type="password" /></label><br>
  <label>Gemini APIã‚­ãƒ¼: <input id="geminiKeyInput" type="password" /></label><br>
  <button id="loadKey">èª­ã¿è¾¼ã¿</button>
  <div id="status"></div>
  <div id="error"></div>
  <br>
  <textarea id="input" placeholder="ã“ã“ã«èª¤ã‚Šã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã„æ—¥æœ¬èªã®æ–‡ç« ã‚’å…¥åŠ›..."></textarea>
  <button id="analyze">æ·»å‰Šã™ã‚‹</button>
  <div id="spinner">ğŸ”„ æ·»å‰Šä¸­...</div>
  <div id="output"></div>

  <script>
    let apiKey = "";
    let geminiKey = "";
    let useGemini = false;

    document.getElementById("loadKey").addEventListener("click", () => {
      apiKey = document.getElementById("apiKeyInput").value.trim();
      geminiKey = document.getElementById("geminiKeyInput").value.trim();
      useGemini = !!geminiKey;
      document.getElementById("status").textContent = useGemini ? "Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚" : "ChatGPT APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚";
      document.getElementById("error").textContent = "";
    });

    document.getElementById("analyze").addEventListener("click", runCheck);
    document.getElementById("input").addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key.toLowerCase() === "k") {
        e.preventDefault();
        runCheck();
      }
    });

    async function runCheck() {
      const text = document.getElementById("input").value;
      document.getElementById("spinner").style.display = "inline";
      document.getElementById("output").innerHTML = "";

      const prompt = `æ¬¡ã®æ—¥æœ¬èªæ–‡ã®ä¸­ã§èª¤ã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’ ** ã§å›²ã‚“ã§ãã ã•ã„ã€‚æ­£ã—ã„æ–‡ç« ã«ç›´ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\n${text}`;

      try {
        const result = useGemini
          ? await fetchGemini(prompt)
          : await fetchChatGPT(prompt);
        const html = escapeHtml(result).replace(/\*\*(.+?)\*\*/g, '<span class="highlight">$1</span>');
        document.getElementById("output").innerHTML = html;
      } catch (err) {
        document.getElementById("error").textContent = err.message || "API ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      } finally {
        document.getElementById("spinner").style.display = "none";
      }
    }

    function escapeHtml(str) {
      return str.replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
      }[tag]));
    }

    async function fetchChatGPT(text) {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: "You are a Japanese proofreader. You only highlight errors using **." },
            { role: "user", content: text }
          ],
          temperature: 0.3,
          max_tokens: 2056
        })
      });
      if (!response.ok) throw new Error("ChatGPT API ã‚¨ãƒ©ãƒ¼: " + response.status);
      const data = await response.json();
      return data.choices?.[0]?.message?.content || "";
    }

    async function fetchGemini(text) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`;
      const body = {
        contents: [{ role: "user", parts: [{ text }] }],
        generationConfig: { temperature: 0.3, maxOutputTokens: 2056 }
      };
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error("Gemini API ã‚¨ãƒ©ãƒ¼: " + res.status);
      const data = await res.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
    }
  </script>
</body>
</html>
